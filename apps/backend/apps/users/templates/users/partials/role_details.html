{% load i18n %}

<!-- Role Header -->
<div class="mb-6">
  <div class="flex items-center justify-between">
    <h4 class="text-lg font-semibold text-gray-900">{{ role.name }}</h4>
    <div class="flex space-x-2">
      {% if role.name not in 'Admin,Staff,Teacher,Student' %}
        <button onclick="deleteRole({{ role.id }})" 
                class="text-red-600 hover:text-red-800 text-sm"
                title="{% trans 'Delete Role' %}">
          <i class="fas fa-trash"></i>
        </button>
      {% endif %}
    </div>
  </div>
  <div class="mt-2 text-sm text-gray-600">
    <i class="fas fa-users mr-1"></i>
    {% blocktrans count counter=role_users|length %}{{ counter }} user{% plural %}{{ counter }} users{% endblocktrans %}
    â€¢
    <i class="fas fa-key ml-2 mr-1"></i>
    {% blocktrans count counter=role_permissions|length %}{{ counter }} permission{% plural %}{{ counter }} permissions{% endblocktrans %}
  </div>
</div>

<!-- Permissions Section -->
<div class="mb-6">
  <h5 class="text-sm font-medium text-gray-900 mb-3">{% trans "Permissions" %}</h5>
  {% if permissions_by_app %}
    <div class="space-y-3">
      {% for app_label, permissions in permissions_by_app.items %}
        <div class="bg-gray-50 rounded-lg p-3">
          <div class="font-medium text-gray-700 text-sm mb-2 capitalize">
            <i class="fas fa-cube mr-1"></i>
            {{ app_label|title }}
          </div>
          <div class="flex flex-wrap gap-1">
            {% for permission in permissions %}
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">
                {{ permission.name|truncatechars:20 }}
              </span>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-4 text-gray-500">
      <i class="fas fa-key text-2xl mb-2"></i>
      <p class="text-sm">{% trans "No permissions assigned to this role" %}</p>
    </div>
  {% endif %}
</div>

<!-- Users Section -->
<div class="mb-6">
  <h5 class="text-sm font-medium text-gray-900 mb-3">{% trans "Users with this Role" %}</h5>
  {% if role_users %}
    <div class="space-y-2 max-h-40 overflow-y-auto">
      {% for user in role_users %}
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
          <div class="flex items-center">
            <div class="h-6 w-6 rounded-full bg-gray-300 flex items-center justify-center mr-2">
              <span class="text-xs font-medium text-gray-700">
                {{ user.first_name|first|default:user.username|first }}
              </span>
            </div>
            <div>
              <div class="text-sm font-medium text-gray-900">
                {{ user.get_full_name|default:user.username }}
              </div>
              <div class="text-xs text-gray-500">{{ user.username }}</div>
            </div>
          </div>
          
          <!-- User type indicator -->
          <div class="flex items-center space-x-1">
            {% if user.studentprofile %}
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-purple-100 text-purple-800">
                <i class="fas fa-user-graduate mr-1"></i>
                {% trans "Student" %}
              </span>
            {% endif %}
            {% if user.teacherprofile %}
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-green-100 text-green-800">
                <i class="fas fa-chalkboard-teacher mr-1"></i>
                {% trans "Teacher" %}
              </span>
            {% endif %}
            {% if user.is_staff %}
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-800">
                <i class="fas fa-user-tie mr-1"></i>
                {% trans "Staff" %}
              </span>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-4 text-gray-500">
      <i class="fas fa-users text-2xl mb-2"></i>
      <p class="text-sm">{% trans "No users assigned to this role" %}</p>
    </div>
  {% endif %}
</div>

<script>
function deleteRole(roleId) {
  if (confirm('{% trans "Are you sure you want to delete this role? This action cannot be undone." %}')) {
    fetch(`/users/role/${roleId}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast(data.message, 'success');
        // Reload the page to refresh the role list
        window.location.reload();
      } else {
        showToast(data.error, 'error');
      }
    })
    .catch(error => {
      showToast('Failed to delete role', 'error');
    });
  }
}
</script>