{% extends "web_interface/base/base.html" %}
{% load i18n %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<!-- Cashier Dashboard -->
<div class="min-h-screen bg-gray-50">
    <!-- Header Section -->
    <div class="bg-white shadow-sm border-b border-gray-200 mb-6">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">{% trans "Cashier Dashboard" %}</h1>
                    <p class="text-sm text-gray-600 mt-1">
                        {% trans "Session" %}: {{ session.session_number }} | 
                        {% trans "Opened" %}: {{ session.opened_at|date:"M d, Y g:i A" }}
                    </p>
                </div>
                
                <!-- Session Controls -->
                <div class="flex items-center space-x-3">
                    <button onclick="openCashDrawer()" 
                            class="sis-btn sis-btn-secondary">
                        <i class="fas fa-cash-register mr-2"></i>
                        {% trans "Cash Drawer" %}
                    </button>
                    <div class="sis-badge sis-badge-success">
                        {% trans "Session Active" %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="px-6">
        <!-- Statistics Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <!-- Total Transactions -->
            <div class="sis-card">
                <div class="p-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-receipt text-blue-600"></i>
                            </div>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-500">{% trans "Transactions Today" %}</p>
                            <p class="text-2xl font-bold text-gray-900">{{ cashier_stats.transactions_today }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cash Received -->
            <div class="sis-card">
                <div class="p-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-dollar-sign text-green-600"></i>
                            </div>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-500">{% trans "Cash Received" %}</p>
                            <p class="text-2xl font-bold text-green-600">${{ cashier_stats.cash_received|floatformat:2 }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Payments -->
            <div class="sis-card">
                <div class="p-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-credit-card text-purple-600"></i>
                            </div>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-500">{% trans "Card Payments" %}</p>
                            <p class="text-2xl font-bold text-purple-600">${{ cashier_stats.card_received|floatformat:2 }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Received -->
            <div class="sis-card">
                <div class="p-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-chart-line text-indigo-600"></i>
                            </div>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-500">{% trans "Total Received" %}</p>
                            <p class="text-2xl font-bold text-indigo-600">${{ cashier_stats.total_received|floatformat:2 }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Student Search & Payment Form (Left Column) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Student Search -->
                <div class="sis-card">
                    <div class="sis-card-header">
                        <h3 class="sis-card-title">{% trans "Student Search" %}</h3>
                    </div>
                    <div class="sis-card-content">
                        <!-- Search Input -->
                        <div class="mb-4">
                            <input type="text" 
                                   id="student-search"
                                   placeholder="{% trans 'Search by Student ID, Name, Email, or Phone...' %}"
                                   class="sis-input w-full"
                                   hx-get="{% url 'web_interface:cashier-student-search' %}"
                                   hx-trigger="input changed delay:300ms"
                                   hx-target="#student-search-results"
                                   autocomplete="off">
                        </div>
                        
                        <!-- Search Results -->
                        <div id="student-search-results" class="min-h-[100px]">
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-search text-2xl mb-2"></i>
                                <p>{% trans "Start typing to search for students..." %}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Form (Hidden until student selected) -->
                <div id="payment-form-container" class="hidden">
                    <div class="sis-card">
                        <div class="sis-card-header">
                            <h3 class="sis-card-title">{% trans "Process Payment" %}</h3>
                        </div>
                        <div class="sis-card-content">
                            <form id="payment-form" 
                                  hx-post="{% url 'web_interface:process-payment' %}"
                                  hx-target="#payment-result"
                                  hx-swap="innerHTML">
                                
                                <input type="hidden" id="selected-student-id" name="student_id">
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <!-- Payment Amount -->
                                    <div>
                                        <label class="sis-label">{% trans "Payment Amount" %}</label>
                                        <input type="number" 
                                               name="amount" 
                                               step="0.01" 
                                               min="0.01"
                                               class="sis-input" 
                                               placeholder="0.00" 
                                               required>
                                    </div>

                                    <!-- Payment Method -->
                                    <div>
                                        <label class="sis-label">{% trans "Payment Method" %}</label>
                                        <select name="payment_method" class="sis-input" required>
                                            {% for value, label in payment_method_choices %}
                                                <option value="{{ value }}">{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <!-- Currency -->
                                    <div>
                                        <label class="sis-label">{% trans "Currency" %}</label>
                                        <select name="currency" class="sis-input">
                                            {% for currency in currency_choices %}
                                                <option value="{{ currency }}" {% if currency == "USD" %}selected{% endif %}>
                                                    {{ currency }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <!-- Reference/Notes -->
                                    <div>
                                        <label class="sis-label">{% trans "Notes (Optional)" %}</label>
                                        <input type="text" 
                                               name="notes" 
                                               class="sis-input" 
                                               placeholder="{% trans 'Payment notes...' %}">
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <button type="submit" class="sis-btn sis-btn-primary w-full">
                                    <i class="fas fa-credit-card mr-2"></i>
                                    {% trans "Process Payment" %}
                                </button>
                            </form>

                            <!-- Payment Result -->
                            <div id="payment-result" class="mt-4"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="space-y-6">
                <!-- Selected Student Details -->
                <div id="student-details" class="hidden">
                    <!-- Populated by HTMX when student is selected -->
                </div>

                <!-- Recent Transactions -->
                <div class="sis-card">
                    <div class="sis-card-header">
                        <h3 class="sis-card-title">{% trans "Recent Transactions" %}</h3>
                    </div>
                    <div class="sis-card-content">
                        {% if today_payments %}
                            <div class="space-y-3">
                                {% for payment in today_payments %}
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div class="flex-1">
                                            <p class="font-medium text-sm">{{ payment.invoice.student.person.full_name }}</p>
                                            <p class="text-xs text-gray-600">
                                                {{ payment.payment_method }} - {{ payment.payment_date|date:"g:i A" }}
                                            </p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-green-600">${{ payment.amount|floatformat:2 }}</p>
                                            <button onclick="showReceipt({{ payment.id }})" 
                                                    class="text-xs text-blue-600 hover:text-blue-800">
                                                {% trans "Receipt" %}
                                            </button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-receipt text-2xl mb-2"></i>
                                <p>{% trans "No transactions today" %}</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Pending Invoices -->
                <div class="sis-card">
                    <div class="sis-card-header">
                        <h3 class="sis-card-title">{% trans "Pending Invoices" %}</h3>
                    </div>
                    <div class="sis-card-content">
                        {% if pending_invoices %}
                            <div class="space-y-3">
                                {% for invoice in pending_invoices %}
                                    <div class="p-3 bg-orange-50 border border-orange-200 rounded-lg">
                                        <p class="font-medium text-sm">{{ invoice.student.person.full_name }}</p>
                                        <p class="text-xs text-gray-600 mb-1">
                                            {{ invoice.invoice_number }} - Due: {{ invoice.due_date|date:"M d" }}
                                        </p>
                                        <p class="font-bold text-orange-600">${{ invoice.amount_due|floatformat:2 }}</p>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-check-circle text-2xl mb-2"></i>
                                <p>{% trans "No pending invoices" %}</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cash Drawer Modal -->
<div id="cash-drawer-modal" class="sis-modal" style="display: none;">
    <div class="sis-modal-content max-w-md">
        <div class="sis-modal-header">
            <h3 class="sis-modal-title">{% trans "Cash Drawer Management" %}</h3>
            <button onclick="closeCashDrawer()" class="sis-modal-close">&times;</button>
        </div>
        <div id="cash-drawer-content">
            <!-- Populated by HTMX -->
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div id="receipt-modal" class="sis-modal" style="display: none;">
    <div class="sis-modal-content max-w-lg">
        <div class="sis-modal-header">
            <h3 class="sis-modal-title">{% trans "Payment Receipt" %}</h3>
            <button onclick="closeReceipt()" class="sis-modal-close">&times;</button>
        </div>
        <div id="receipt-content">
            <!-- Populated by HTMX -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Student Selection
let selectedStudentId = null;

function selectStudent(studentId, studentName) {
    selectedStudentId = studentId;
    document.getElementById('selected-student-id').value = studentId;
    
    // Show payment form
    document.getElementById('payment-form-container').classList.remove('hidden');
    
    // Load student details
    htmx.ajax('GET', `/cashier/student/${studentId}/`, {
        target: '#student-details',
        swap: 'innerHTML'
    }).then(() => {
        document.getElementById('student-details').classList.remove('hidden');
    });
    
    // Clear search
    document.getElementById('student-search').value = '';
    document.getElementById('student-search-results').innerHTML = `
        <div class="text-center text-green-600 py-4">
            <i class="fas fa-check-circle text-2xl mb-2"></i>
            <p>${studentName} selected</p>
        </div>
    `;
}

// Cash Drawer Management
function openCashDrawer() {
    document.getElementById('cash-drawer-modal').style.display = 'flex';
    htmx.ajax('GET', '/cashier/cash-drawer/', {
        target: '#cash-drawer-content',
        swap: 'innerHTML'
    });
}

function closeCashDrawer() {
    document.getElementById('cash-drawer-modal').style.display = 'none';
}

// Receipt Display
function showReceipt(paymentId) {
    document.getElementById('receipt-modal').style.display = 'flex';
    htmx.ajax('GET', `/cashier/receipt/${paymentId}/?format=modal`, {
        target: '#receipt-content',
        swap: 'innerHTML'
    });
}

function closeReceipt() {
    document.getElementById('receipt-modal').style.display = 'none';
}

// Payment Success Handler
document.body.addEventListener('paymentSuccess', function(e) {
    // Refresh statistics and recent transactions
    location.reload();
});

// Auto-focus search on load
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('student-search').focus();
});
</script>
{% endblock %}