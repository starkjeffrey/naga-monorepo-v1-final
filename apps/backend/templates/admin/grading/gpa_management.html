{% extends "admin/base_site.html" %}

{% load i18n admin_urls static admin_modify
%}

{% block title %}
  GPA Management | {{ site_title|default:"Django site admin"
  }}
{% endblock %}
{% block extrahead %}
  <style>
    .gpa-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .summary-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .summary-card .number {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .summary-card .label {
      font-size: 14px;
      color: #666;
      text-transform: uppercase;
    }

    .summary-card.excellent .number {
      color: #28a745;
    }

    .summary-card.good .number {
      color: #0066cc;
    }

    .summary-card.warning .number {
      color: #fd7e14;
    }

    .summary-card.danger .number {
      color: #dc3545;
    }

    .filters-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .filter-row {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      align-items: center;
    }

    .filter-group {
      flex: 1;
    }

    .filter-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .filter-group select,
    .filter-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .gpa-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .gpa-table th,
    .gpa-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .gpa-table th {
      background-color: #f5f5f5;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .gpa-table tbody tr:hover {
      background-color: #f9f9f9;
    }

    .gpa-value {
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .gpa-excellent {
      background: #d4edda;
      color: #155724;
    }

    .gpa-good {
      background: #cce5ff;
      color: #004085;
    }

    .gpa-satisfactory {
      background: #fff3cd;
      color: #856404;
    }

    .gpa-warning {
      background: #f8d7da;
      color: #721c24;
    }

    .academic-standing {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .standing-excellent {
      background: #d4edda;
      color: #155724;
    }

    .standing-good {
      background: #cce5ff;
      color: #004085;
    }

    .standing-warning {
      background: #fff3cd;
      color: #856404;
    }

    .standing-probation {
      background: #f8d7da;
      color: #721c24;
    }

    .actions-column {
      white-space: nowrap;
    }

    .actions-column button {
      margin-right: 5px;
      font-size: 11px;
      padding: 4px 8px;
    }

    .bulk-actions {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .trend-indicator {
      font-size: 12px;
      margin-left: 5px;
    }

    .trend-up {
      color: #28a745;
    }

    .trend-down {
      color: #dc3545;
    }

    .trend-stable {
      color: #6c757d;
    }

    .pagination {
      text-align: center;
      margin: 20px 0;
    }

    .pagination button {
      margin: 0 5px;
      padding: 8px 16px;
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Filter functionality
      const filters = {
        term: document.getElementById('filter-term'),
        program: document.getElementById('filter-program'),
        standing: document.getElementById('filter-standing'),
        gpaRange: document.getElementById('filter-gpa-range'),
        search: document.getElementById('filter-search'),
      };

      function applyFilters() {
        const rows = document.querySelectorAll('.gpa-table tbody tr');

        rows.forEach((row) => {
          let show = true;

          // Term filter
          if (filters.term.value && row.dataset.term !== filters.term.value) {
            show = false;
          }

          // Program filter
          if (
            filters.program.value &&
            row.dataset.program !== filters.program.value
          ) {
            show = false;
          }

          // Standing filter
          if (
            filters.standing.value &&
            row.dataset.standing !== filters.standing.value
          ) {
            show = false;
          }

          // GPA range filter
          if (filters.gpaRange.value) {
            const gpa = parseFloat(row.dataset.gpa);
            const [min, max] = filters.gpaRange.value.split('-').map(parseFloat);
            if (gpa < min || gpa > max) {
              show = false;
            }
          }

          // Search filter
          if (filters.search.value) {
            const searchTerm = filters.search.value.toLowerCase();
            const studentName = row
              .querySelector('.student-name')
              .textContent.toLowerCase();
            const studentId = row
              .querySelector('.student-id')
              .textContent.toLowerCase();
            if (
              !studentName.includes(searchTerm) &&
              !studentId.includes(searchTerm)
            ) {
              show = false;
            }
          }

          row.style.display = show ? '' : 'none';
        });

        updateSummaryCards();
      }

      function updateSummaryCards() {
        const visibleRows = document.querySelectorAll(
          '.gpa-table tbody tr[style=""], .gpa-table tbody tr:not([style])'
        );

        let excellentCount = 0;
        let goodCount = 0;
        let warningCount = 0;
        let probationCount = 0;

        visibleRows.forEach((row) => {
          const standing = row.dataset.standing;
          switch (standing) {
            case 'EXCELLENT':
              excellentCount++;
              break;
            case 'GOOD':
              goodCount++;
              break;
            case 'WARNING':
              warningCount++;
              break;
            case 'PROBATION':
              probationCount++;
              break;
          }
        });

        document.getElementById('excellent-count').textContent = excellentCount;
        document.getElementById('good-count').textContent = goodCount;
        document.getElementById('warning-count').textContent = warningCount;
        document.getElementById('probation-count').textContent = probationCount;
      }

      // Add event listeners to filters
      Object.values(filters).forEach((filter) => {
        filter.addEventListener('change', applyFilters);
        filter.addEventListener('input', applyFilters);
      });

      // Bulk selection
      document
        .getElementById('select-all')
        .addEventListener('change', function() {
          const checkboxes = document.querySelectorAll(
            '.student-checkbox:not([style*="none"])'
          );
          checkboxes.forEach((cb) => (cb.checked = this.checked));
        });
    });

    function recalculateGPA(studentId) {
      if (
        confirm(
          'Recalculate GPA for this student? This will update their academic record.'
        )
      ) {
        // AJAX call to recalculate GPA
        fetch(`/admin/grading/recalculate-gpa/${studentId}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')
                .value,
              'Content-Type': 'application/json',
            },
          })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              location.reload();
            } else {
              alert('Error recalculating GPA: ' + data.error);
            }
          })
          .catch((error) => {
            alert('Error recalculating GPA: ' + error);
          });
      }
    }

    function viewTranscript(studentId) {
      window.open(`/admin/students/${studentId}/transcript/`, '_blank');
    }

    function updateStanding(studentId) {
      if (
        confirm('Update academic standing for this student based on current GPA?')
      ) {
        // AJAX call to update standing
        fetch(`/admin/grading/update-standing/${studentId}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')
                .value,
              'Content-Type': 'application/json',
            },
          })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              location.reload();
            } else {
              alert('Error updating standing: ' + data.error);
            }
          })
          .catch((error) => {
            alert('Error updating standing: ' + error);
          });
      }
    }

    function bulkRecalculate() {
      const selected = document.querySelectorAll('.student-checkbox:checked');
      if (selected.length === 0) {
        alert('Please select at least one student.');
        return;
      }

      if (confirm(`Recalculate GPA for ${selected.length} selected students?`)) {
        // Implementation for bulk recalculation
        alert('GPAs recalculated for selected students!');
      }
    }

    function bulkUpdateStanding() {
      const selected = document.querySelectorAll('.student-checkbox:checked');
      if (selected.length === 0) {
        alert('Please select at least one student.');
        return;
      }

      if (
        confirm(
          `Update academic standing for ${selected.length} selected students?`
        )
      ) {
        // Implementation for bulk standing update
        alert('Academic standing updated for selected students!');
      }
    }

    function exportGPAReport() {
      const params = new URLSearchParams({
        term: document.getElementById('filter-term').value,
        program: document.getElementById('filter-program').value,
        standing: document.getElementById('filter-standing').value,
        gpa_range: document.getElementById('filter-gpa-range').value,
      });

      window.open(`/admin/grading/export-gpa-report/?${params}`, '_blank');
    }
  </script>
{% endblock %}
{% block content %}
  <div class="gpa-container">
    <h1>GPA Management & Academic Standing</h1>
    <div class="summary-cards">
      <div class="summary-card excellent">
        <div class="number" id="excellent-count">{{ excellent_count }}</div>
        <div class="label">Excellent (3.5+)</div>
      </div>
      <div class="summary-card good">
        <div class="number" id="good-count">{{ good_count }}</div>
        <div class="label">Good (3.0-3.49)</div>
      </div>
      <div class="summary-card warning">
        <div class="number" id="warning-count">{{ warning_count }}</div>
        <div class="label">Warning (2.0-2.99)</div>
      </div>
      <div class="summary-card danger">
        <div class="number" id="probation-count">{{ probation_count }}</div>
        <div class="label">
          Probation (<2.0 )
        </div>
      </div>
    </div>
    <div class="filters-section">
      <h3>Filters</h3>
      <div class="filter-row">
        <div class="filter-group">
          <label for="filter-term">Term:</label>
          <select id="filter-term">
            <option value="">All Terms</option>
            {% for term in terms %}<option value="{{ term.id }}">{{ term.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-program">Program:</label>
          <select id="filter-program">
            <option value="">All Programs</option>
            {% for program in programs %}<option value="{{ program.id }}">{{ program.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-standing">Academic Standing:</label>
          <select id="filter-standing">
            <option value="">All Standing</option>
            <option value="EXCELLENT">Excellent</option>
            <option value="GOOD">Good</option>
            <option value="WARNING">Warning</option>
            <option value="PROBATION">Probation</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-gpa-range">GPA Range:</label>
          <select id="filter-gpa-range">
            <option value="">All GPAs</option>
            <option value="3.5-4.0">3.5 - 4.0</option>
            <option value="3.0-3.49">3.0 - 3.49</option>
            <option value="2.0-2.99">2.0 - 2.99</option>
            <option value="0.0-1.99">Below 2.0</option>
          </select>
        </div>
      </div>
      <div class="filter-row">
        <div class="filter-group">
          <label for="filter-search">Search Student:</label>
          <input type="text"
                 id="filter-search"
                 placeholder="Search by name or student ID..." />
        </div>
        <div class="filter-group">
          <label>&nbsp;</label>
          <button type="button" class="button" onclick="exportGPAReport()">Export Report</button>
        </div>
      </div>
    </div>
    <div class="bulk-actions">
      <label>
        <input type="checkbox" id="select-all" />
        Select All Visible Students
      </label>
      <button type="button" class="button default" onclick="bulkRecalculate()">Recalculate Selected</button>
      <button type="button" class="button default" onclick="bulkUpdateStanding()">Update Standing</button>
    </div>
    <div style="overflow-x: auto">
      <table class="gpa-table">
        <thead>
          <tr>
            <th>
              <input type="checkbox" id="select-all-header" />
            </th>
            <th>Student ID</th>
            <th>Student Name</th>
            <th>Program</th>
            <th>Term GPA</th>
            <th>Cumulative GPA</th>
            <th>Credits Attempted</th>
            <th>Credits Earned</th>
            <th>Academic Standing</th>
            <th>Last Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for gpa_record in gpa_records %}
            <tr data-student-id="{{ gpa_record.student.id }}"
                data-term="{{ gpa_record.term.id }}"
                data-program="{{ gpa_record.student.current_program.id }}"
                data-standing="{{ gpa_record.academic_standing }}"
                data-gpa="{{ gpa_record.gpa_value }}">
              <td>
                <input type="checkbox" class="student-checkbox" value="{{ gpa_record.id }}" />
              </td>
              <td class="student-id">{{ gpa_record.student.student_id }}</td>
              <td class="student-name">
                <strong>{{ gpa_record.student.person.full_name }}</strong>
                <br />
                <small>{{ gpa_record.student.person.email|default:"No email" }}</small>
              </td>
              <td>{{ gpa_record.student.current_program.name|default:"No program" }}</td>
              <td>
                <span class="gpa-value {% if gpa_record.gpa_value >= 3.5 %}gpa-excellent{% elif gpa_record.gpa_value >= 3.0 %}gpa-good{% elif gpa_record.gpa_value >= 2.0 %}gpa-satisfactory{% else %}gpa-warning{% endif %}">
                  {{ gpa_record.gpa_value|floatformat:2 }}
                </span>
                {% if gpa_record.trend %}
                  <span class="trend-indicator trend-{{ gpa_record.trend }}">
                    {% if gpa_record.trend == 'up' %}
                      ↗
                    {% elif gpa_record.trend ==
                      'down' %}
                      ↘
                    {% else %}
                      →
                    {% endif %}
                  </span>
                {% endif %}
              </td>
              <td>
                <span class="gpa-value {% if gpa_record.cumulative_gpa >= 3.5 %}gpa-excellent{% elif gpa_record.cumulative_gpa >= 3.0 %}gpa-good{% elif gpa_record.cumulative_gpa >= 2.0 %}gpa-satisfactory{% else %}gpa-warning{% endif %}">
                  {{ gpa_record.cumulative_gpa|floatformat:2|default:"-" }}
                </span>
              </td>
              <td>{{ gpa_record.credit_hours_attempted|floatformat:0 }}</td>
              <td>{{ gpa_record.credit_hours_earned|floatformat:0 }}</td>
              <td>
                <span class="academic-standing {% if gpa_record.academic_standing == 'EXCELLENT' %}standing-excellent{% elif gpa_record.academic_standing == 'GOOD' %}standing-good{% elif gpa_record.academic_standing == 'WARNING' %}standing-warning{% else %}standing-probation{% endif %}">
                  {{ gpa_record.get_academic_standing_display|default:"Pending" }}
                </span>
              </td>
              <td>
                <small>{{ gpa_record.calculated_at|date:"M j, Y" }}</small>
              </td>
              <td class="actions-column">
                <button type="button"
                        class="button"
                        onclick="recalculateGPA({{ gpa_record.student.id }})">Recalc</button>
                <button type="button"
                        class="button default"
                        onclick="viewTranscript({{ gpa_record.student.id }})">Transcript</button>
                <button type="button"
                        class="button default"
                        onclick="updateStanding({{ gpa_record.student.id }})">Standing</button>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="11" style="text-align: center; padding: 40px; color: #666">
                No GPA records found.
                <a href="#" onclick="bulkRecalculate()">Calculate GPAs</a> for all
                students.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="pagination">
      {% if page_obj.has_previous %}
        <button type="button"
                class="button default"
                onclick="location.href='?page=1'">First</button>
        <button type="button"
                class="button default"
                onclick="location.href='?page={{ page_obj.previous_page_number }}'">Previous</button>
      {% endif %}
      <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <button type="button"
                class="button default"
                onclick="location.href='?page={{ page_obj.next_page_number }}'">Next</button>
        <button type="button"
                class="button default"
                onclick="location.href='?page={{ page_obj.paginator.num_pages }}'">Last</button>
      {% endif %}
    </div>
    <div style="margin-top: 30px">
      <h3>Academic Standing Guidelines</h3>
      <ul>
        <li>
          <strong>Excellent (3.5+):</strong> Dean's List eligibility, academic
          honors
        </li>
        <li>
          <strong>Good (3.0-3.49):</strong> Good academic standing, eligible for
          most programs
        </li>
        <li>
          <strong>Warning (2.0-2.99):</strong> Academic warning, may require
          advising
        </li>
        <li>
          <strong>Probation (<2.0):</strong> Academic probation, intervention
          required
        </li>
      </ul>
    </div>
    <div style="margin-top: 20px">
      <a href="{% url 'admin:grading_gparecord_changelist' %}" class="button">« Back to Grade Management</a>
    </div>
  </div>
  {% csrf_token %}
{% endblock %}
