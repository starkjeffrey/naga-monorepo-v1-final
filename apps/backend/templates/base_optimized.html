{% load static i18n compress %}

<!DOCTYPE html>
{% get_current_language as LANGUAGE_CODE %}
<html lang="{{ LANGUAGE_CODE }}" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>
      {% block title %}
        {{ system_name|default:"PUCSR SIS" }}
      {% endblock title %}
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
          content="Pannasastra University of Cambodia Student Information System" />
    <link rel="icon" href="{% static 'favicon.ico' %}" />
    <link rel="apple-touch-icon" href="{% static 'images/naga-trans.png' %}" />
    
    {% block css %}
      <!-- DNS Prefetch for faster resolution -->
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" />
      <link rel="dns-prefetch" href="https://cdn.tailwindcss.com" />
      <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
      <link rel="dns-prefetch" href="https://unpkg.com" />
      
      <!-- Preconnect to external domains -->
      <link rel="preconnect" href="https://fonts.googleapis.com" />
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
      <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
      
      <!-- Critical inline CSS for immediate rendering -->
      <style>
        /* Critical CSS for above-the-fold content */
        body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          margin: 0;
          padding: 0;
        }
        .loading {
          display: flex;
          justify-content: center;
          align-items: center;
          min-height: 100vh;
          background: #f8fafc;
        }
        .spinner {
          border: 3px solid #e2e8f0;
          border-top: 3px solid #3b82f6;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        /* Hide content until CSS loads */
        .content-wrapper {
          visibility: hidden;
          opacity: 0;
          transition: opacity 0.2s ease-in;
        }
        .content-loaded .content-wrapper {
          visibility: visible;
          opacity: 1;
        }
      </style>
      
      <!-- Load critical CSS first -->
      {% compress css %}
      <link href="{% static 'css/layout.css' %}" rel="stylesheet" />
      {% endcompress %}
      
      <!-- Async load non-critical CSS -->
      <link rel="preload" href="https://cdn.tailwindcss.com" as="script" />
      <link rel="preload" 
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" 
            as="style" 
            onload="this.onload=null;this.rel='stylesheet'" />
      <link rel="preload"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
            as="style"
            onload="this.onload=null;this.rel='stylesheet'"
            integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer" />
      
      <!-- Fallback for browsers without preload support -->
      <noscript>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
              rel="stylesheet" />
        <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
      </noscript>
      
      {% block extra_css %}
      {% endblock extra_css %}
    {% endblock css %}
    
    <!-- Load Tailwind CSS with async pattern for better performance -->
    <script>
      // Load Tailwind CSS asynchronously
      (function() {
        var script = document.createElement('script');
        script.src = 'https://cdn.tailwindcss.com';
        script.onload = function() {
          document.body.classList.add('content-loaded');
        };
        document.head.appendChild(script);
      })();
    </script>
  </head>
  <body class="antialiased bg-slate-50 dark:bg-slate-900">
    <!-- Loading indicator -->
    <div id="initial-loader" class="loading">
      <div class="spinner"></div>
    </div>
    
    <!-- Main content wrapper -->
    <div class="content-wrapper relative min-h-screen lg:flex">
      {% if request.user.is_authenticated %}
        <!-- Sidebar -->
        {% include 'components/sidebar.html' %}
        <!-- Mobile Overlay -->
        <div id="mobile-overlay"
             class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden"
             aria-hidden="true"></div>
        <!-- Main Content Area -->
        <div id="main-content" class="flex-1 flex flex-col">
          <!-- Header -->
          {% include 'components/header.html' %}
          <!-- Main Page Content -->
          <main class="flex-grow" role="main">
            {% include 'components/messages.html' %}
            {% block content %}
            {% endblock content %}
          </main>
        </div>
      {% else %}
        <!-- Login Container -->
        <div class="w-full">
          {% block login_content %}
          {% endblock login_content %}
        </div>
      {% endif %}
    </div>
    
    {% block javascript %}
      <!-- Defer non-critical JavaScript -->
      <script src="https://unpkg.com/htmx.org@1.9.10"
              defer
              integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC"
              crossorigin="anonymous"></script>
      
      <!-- Application JavaScript with compression -->
      {% compress js %}
      <script src="{% static 'js/layout.js' %}" defer></script>
      {% endcompress %}
      
      <!-- Hide loader when page loads -->
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var loader = document.getElementById('initial-loader');
          if (loader) {
            loader.style.display = 'none';
          }
          document.body.classList.add('content-loaded');
        });
      </script>
      
      {% block extra_js %}
      {% endblock extra_js %}
    {% endblock javascript %}
  </body>
</html>