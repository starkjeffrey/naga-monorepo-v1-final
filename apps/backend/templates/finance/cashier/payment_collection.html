{% extends "base_new.html" %}

{% load static i18n humanize %}

{% block title %}Collect Payment - {{ student }} - {{ block.super }}{% endblock %}
{% block extra_css %}
  <style>
    .invoice-item {
      @apply border-l-4 border-transparent hover:border-blue-500 transition-all duration-200;
    }

    .invoice-item.selected {
      @apply bg-blue-50 border-blue-500;
    }

    .payment-method-option {
      @apply p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all duration-200;
    }

    .payment-method-option:hover {
      @apply border-blue-300 bg-blue-50;
    }

    .payment-method-option.selected {
      @apply border-blue-500 bg-blue-100;
    }
  </style>
{% endblock %}
{% block content %}
  <div class="container mx-auto px-4 py-6" x-data="paymentCollection()">
    <!-- Header -->
    <div class="mb-6">
      <a href="{% url 'finance:cashier-dashboard' %}"
         class="text-blue-600 hover:text-blue-800 mb-2 inline-block">‚Üê Back to Dashboard</a>
      <h1 class="text-3xl font-bold text-gray-800">Collect Payment</h1>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Student Information -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Student Information</h2>
          {% if student.person.photo %}
            <div class="mb-4">
              <img src="{{ student.person.photo.url }}"
                   alt="{{ student }}"
                   class="w-32 h-32 rounded-full mx-auto object-cover" />
            </div>
          {% endif %}
          <dl class="space-y-2">
            <div>
              <dt class="text-sm font-medium text-gray-500">Name</dt>
              <dd class="text-lg font-semibold text-gray-900">
                {{ student }}
              </dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Student ID</dt>
              <dd class="text-lg text-gray-900">
                {{ student.student_id }}
              </dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Program</dt>
              <dd class="text-sm text-gray-900">
                {{ student.get_current_program_display|default:"N/A" }}
              </dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Phone</dt>
              <dd class="text-sm text-gray-900">
                {{ student.person.phone|default:"N/A" }}
              </dd>
            </div>
            <div class="pt-4 border-t">
              <dt class="text-sm font-medium text-gray-500">Total Balance</dt>
              <dd class="text-2xl font-bold {% if total_balance > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                ${{ total_balance|floatformat:2|intcomma }}
              </dd>
            </div>
          </dl>
        </div>
      </div>
      <!-- Payment Form -->
      <div class="lg:col-span-2">
        <form @submit.prevent="submitPayment()"
              method="post"
              action="{% url 'finance:payment-collection' student.id %}">
          {% csrf_token %}
          <!-- Outstanding Invoices -->
          {% if outstanding_invoices %}
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
              <h2 class="text-xl font-semibold text-gray-800 mb-4">Outstanding Invoices</h2>
              <div class="space-y-2">
                {% for invoice in outstanding_invoices %}
                  <div class="invoice-item p-4 border rounded-lg cursor-pointer"
                       :class="{'selected': selectedInvoices.includes('{{ invoice.id }}')}"
                       @click="toggleInvoice('{{ invoice.id }}', {{ invoice.amount_due }})">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <div class="font-medium text-gray-900">Invoice #{{ invoice.invoice_number }}</div>
                        <div class="text-sm text-gray-500">
                          Due: {{ invoice.due_date|date:"M d, Y" }}
                          {% if invoice.is_overdue %}<span class="text-red-600 font-medium">(OVERDUE)</span>{% endif %}
                        </div>
                      </div>
                      <div class="text-right">
                        <div class="text-lg font-bold text-gray-900">${{ invoice.amount_due|floatformat:2|intcomma }}</div>
                        <input type="checkbox"
                               name="invoice_ids[]"
                               value="{{ invoice.id }}"
                               :checked="selectedInvoices.includes('{{ invoice.id }}')"
                               class="sr-only" />
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
              <div class="mt-4 pt-4 border-t">
                <div class="flex justify-between text-lg font-semibold">
                  <span>Selected Total:</span>
                  <span x-text="'$' + selectedTotal.toFixed(2)"></span>
                </div>
              </div>
            </div>
          {% endif %}
          <!-- Payment Details -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Payment Details</h2>
            <!-- Amount -->
            <div class="mb-6">
              <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">
                Payment Amount <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                <input type="number"
                       id="amount"
                       name="amount"
                       x-model="amount"
                       step="0.01"
                       min="0.01"
                       required
                       class="pl-8 w-full px-4 py-3 text-lg border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                       placeholder="0.00" />
              </div>
              <p class="mt-1 text-sm text-gray-500">Enter the amount received from the student</p>
            </div>
            <!-- Payment Method -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Payment Method <span class="text-red-500">*</span>
              </label>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                {% for method in payment_methods %}
                  <div class="payment-method-option"
                       :class="{'selected': paymentMethod === '{{ method.value }}'}"
                       @click="paymentMethod = '{{ method.value }}'">
                    <input type="radio"
                           name="payment_method"
                           value="{{ method.value }}"
                           x-model="paymentMethod"
                           class="sr-only"
                           required />
                    <div class="text-center">
                      <div class="text-lg font-medium">{{ method.label }}</div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            <!-- Reference Number (for non-cash) -->
            <div class="mb-6" x-show="paymentMethod !== 'CASH'" x-transition>
              <label for="reference" class="block text-sm font-medium text-gray-700 mb-2">Reference Number</label>
              <input type="text"
                     id="reference"
                     name="reference"
                     x-model="reference"
                     class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                     placeholder="Transaction reference or check number" />
            </div>
            <!-- Notes -->
            <div class="mb-6">
              <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
              <textarea id="notes"
                        name="notes"
                        x-model="notes"
                        rows="3"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Additional notes about this payment"></textarea>
            </div>
            <!-- Actions -->
            <div class="flex justify-between items-center pt-4 border-t">
              <a href="{% url 'finance:cashier-dashboard' %}"
                 class="btn btn-secondary">Cancel</a>
              <button type="submit"
                      :disabled="!amount || amount <= 0 || !paymentMethod || processing"
                      class="btn btn-primary">
                <span x-show="!processing">Process Payment</span>
                <span x-show="processing" class="flex items-center">
                  <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white"
                       fill="none"
                       viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                  </svg>
                  Processing...
                </span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}
{% block extra_js %}
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    function paymentCollection() {
      return {
        selectedInvoices: [],
        selectedTotal: 0,
        amount: '',
        paymentMethod: '',
        reference: '',
        notes: '',
        processing: false,

        toggleInvoice(invoiceId, amountDue) {
          const index = this.selectedInvoices.indexOf(invoiceId);
          if (index > -1) {
            this.selectedInvoices.splice(index, 1);
            this.selectedTotal -= amountDue;
          } else {
            this.selectedInvoices.push(invoiceId);
            this.selectedTotal += amountDue;
          }

          // Auto-fill amount if selecting invoices
          if (this.selectedInvoices.length > 0) {
            this.amount = this.selectedTotal.toFixed(2);
          }
        },

        async submitPayment() {
          if (this.processing) return;

          // Validate
          if (!this.amount || parseFloat(this.amount) <= 0) {
            Swal.fire('Error', 'Please enter a valid payment amount', 'error');
            return;
          }

          if (!this.paymentMethod) {
            Swal.fire('Error', 'Please select a payment method', 'error');
            return;
          }

          this.processing = true;

          try {
            // Prepare form data
            const formData = new FormData();
            formData.append(
              'csrfmiddlewaretoken',
              document.querySelector('[name=csrfmiddlewaretoken]').value
            );
            formData.append('amount', this.amount);
            formData.append('payment_method', this.paymentMethod);
            formData.append('reference', this.reference);
            formData.append('notes', this.notes);

            // Add selected invoices
            this.selectedInvoices.forEach((id) => {
              formData.append('invoice_ids[]', id);
            });

            // Submit payment
            const response = await fetch(
              '{% url "finance:payment-collection" student.id %}', {
                method: 'POST',
                body: formData,
              }
            );

            const data = await response.json();

            if (data.success) {
              // Show success message
              await Swal.fire({
                icon: 'success',
                title: 'Payment Processed Successfully!',
                html: `
                            <p>Payment of $${parseFloat(this.amount).toFixed(
                              2
                            )} has been collected.</p>
                            <p class="mt-2">Remaining Balance: $${data.remaining_balance.toFixed(
                              2
                            )}</p>
                        `,
                showCancelButton: true,
                confirmButtonText: 'Print Receipt',
                cancelButtonText: 'New Payment',
              }).then((result) => {
                if (result.isConfirmed) {
                  // Open receipt in new window
                  window.open(data.receipt_url, '_blank');
                }
                // Redirect to dashboard
                window.location.href = '{% url "finance:cashier-dashboard" %}';
              });
            } else {
              throw new Error(data.error || 'Payment processing failed');
            }
          } catch (error) {
            console.error('Payment error:', error);
            Swal.fire(
              'Error',
              error.message || 'Failed to process payment',
              'error'
            );
          } finally {
            this.processing = false;
          }
        },
      };
    }
  </script>
{% endblock %}
