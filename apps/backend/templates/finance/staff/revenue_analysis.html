{% extends "base_new.html" %}

{% load static i18n humanize %}

{% block title %}Revenue Analysis - {{ block.super }}{% endblock %}
{% block extra_css %}
  <style>
    .stat-box {
      @apply bg-white rounded-lg shadow p-6;
    }

    .chart-card {
      @apply bg-white rounded-lg shadow p-6;
    }

    .table-card {
      @apply bg-white rounded-lg shadow overflow-hidden;
    }

    .trend-up {
      @apply text-green-600;
    }

    .trend-down {
      @apply text-red-600;
    }
  </style>
{% endblock %}
{% block content %}
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-8">
      <a href="{% url 'finance:finance-dashboard' %}"
         class="text-blue-600 hover:text-blue-800 mb-2 inline-block">‚Üê Back to Dashboard</a>
      <h1 class="text-3xl font-bold text-gray-800">Revenue Analysis</h1>
    </div>
    <!-- Date Range Filter -->
    <div class="bg-gray-50 rounded-lg p-4 mb-6">
      <form method="get" class="flex flex-wrap items-end gap-4">
        <div>
          <label for="start_date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
          <input type="date"
                 id="start_date"
                 name="start_date"
                 value="{{ start_date|date:'Y-m-d' }}"
                 class="px-3 py-2 border border-gray-300 rounded-md" />
        </div>
        <div>
          <label for="end_date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
          <input type="date"
                 id="end_date"
                 name="end_date"
                 value="{{ end_date|date:'Y-m-d' }}"
                 class="px-3 py-2 border border-gray-300 rounded-md" />
        </div>
        <button type="submit" class="btn btn-primary">Update</button>
        <a href="{% url 'finance:revenue-analysis' %}" class="btn btn-secondary">Reset</a>
      </form>
    </div>
    <!-- Summary Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="stat-box">
        <h3 class="text-sm font-medium text-gray-600 mb-2">Total Revenue</h3>
        <p class="text-3xl font-bold text-gray-900">
          ${{ revenue_by_type.total_revenue|default:"0"|floatformat:2|intcomma }}
        </p>
        <p class="text-sm text-gray-500 mt-2">{{ start_date|date:"M d" }} - {{ end_date|date:"M d, Y" }}</p>
      </div>
      <div class="stat-box">
        <h3 class="text-sm font-medium text-gray-600 mb-2">Tuition Revenue</h3>
        <p class="text-2xl font-bold text-blue-600">${{ revenue_by_type.tuition|default:"0"|floatformat:2|intcomma }}</p>
        <p class="text-sm text-gray-500 mt-2">
          {% widthratio revenue_by_type.tuition revenue_by_type.total_revenue 100 %}% of total
        </p>
      </div>
      <div class="stat-box">
        <h3 class="text-sm font-medium text-gray-600 mb-2">Fee Revenue</h3>
        <p class="text-2xl font-bold text-green-600">${{ revenue_by_type.fees|default:"0"|floatformat:2|intcomma }}</p>
        <p class="text-sm text-gray-500 mt-2">
          {% widthratio revenue_by_type.fees revenue_by_type.total_revenue 100 %}% of total
        </p>
      </div>
      <div class="stat-box">
        <h3 class="text-sm font-medium text-gray-600 mb-2">Other Revenue</h3>
        <p class="text-2xl font-bold text-purple-600">${{ revenue_by_type.other|default:"0"|floatformat:2|intcomma }}</p>
        <p class="text-sm text-gray-500 mt-2">
          {% widthratio revenue_by_type.other revenue_by_type.total_revenue 100 %}% of total
        </p>
      </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Revenue by Program -->
      <div class="chart-card">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Revenue by Program</h2>
        <canvas id="programRevenueChart" height="300"></canvas>
        <div class="mt-4 max-h-48 overflow-y-auto">
          <table class="min-w-full">
            <thead>
              <tr class="text-left text-xs font-medium text-gray-500 uppercase">
                <th class="py-2">Program</th>
                <th class="py-2 text-right">Revenue</th>
                <th class="py-2 text-right">%</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              {% for program in revenue_by_program %}
                <tr>
                  <td class="py-2 text-sm">{{ program.name }}</td>
                  <td class="py-2 text-sm text-right font-medium">${{ program.revenue|floatformat:2|intcomma }}</td>
                  <td class="py-2 text-sm text-right text-gray-500">{{ program.percentage|floatformat:1 }}%</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <!-- Revenue by Payment Method -->
      <div class="chart-card">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Revenue by Payment Method</h2>
        <canvas id="paymentMethodRevenueChart" height="300"></canvas>
        <div class="mt-4">
          <table class="min-w-full">
            <thead>
              <tr class="text-left text-xs font-medium text-gray-500 uppercase">
                <th class="py-2">Method</th>
                <th class="py-2 text-right">Transactions</th>
                <th class="py-2 text-right">Revenue</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              {% for method in revenue_by_payment_method %}
                <tr>
                  <td class="py-2 text-sm">{{ method.name }}</td>
                  <td class="py-2 text-sm text-right">{{ method.count }}</td>
                  <td class="py-2 text-sm text-right font-medium">${{ method.revenue|floatformat:2|intcomma }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Daily Revenue Trend -->
    <div class="chart-card mb-8">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Daily Revenue Trend</h2>
      <canvas id="dailyRevenueChart" height="100"></canvas>
    </div>
    <!-- Top Revenue Courses -->
    <div class="table-card">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-800">Top Revenue Generating Courses</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course Code</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course Name</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Enrollments</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Avg per Student</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for course in top_revenue_courses %}
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ course.code }}</td>
                <td class="px-6 py-4 text-sm text-gray-900">{{ course.name }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-right">{{ course.enrollments }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium">
                  ${{ course.revenue|floatformat:2|intcomma }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">
                  ${{ course.avg_per_student|floatformat:2 }}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="px-6 py-4 text-center text-gray-500">No revenue data available for the selected period</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <!-- Export Options -->
    <div class="mt-8 flex justify-end space-x-3">
      <button onclick="exportToCSV()" class="btn btn-secondary">
        <svg class="w-5 h-5 mr-2"
             fill="none"
             stroke="currentColor"
             viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
          </path>
        </svg>
        Export to CSV
      </button>
      <button onclick="window.print()" class="btn btn-secondary">
        <svg class="w-5 h-5 mr-2"
             fill="none"
             stroke="currentColor"
             viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z">
          </path>
        </svg>
        Print Report
      </button>
    </div>
  </div>
{% endblock %}
{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script>
    // Revenue by Program Chart
    const programCtx = document.getElementById('programRevenueChart').getContext('2d');
    const programData = {
      {
        revenue_by_program | safe
      }
    };

    new Chart(programCtx, {
      type: 'pie',
      data: {
        labels: programData.map(p => p.name),
        datasets: [{
          data: programData.map(p => p.revenue),
          backgroundColor: [
            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
            '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#84cc16'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              padding: 15,
              font: {
                size: 11
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.parsed;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return context.label + ': $' + value.toLocaleString() + ' (' + percentage + '%)';
              }
            }
          }
        }
      }
    });

    // Revenue by Payment Method Chart
    const paymentMethodCtx = document.getElementById('paymentMethodRevenueChart').getContext('2d');
    const paymentMethodData = {
      {
        revenue_by_payment_method | safe
      }
    };

    new Chart(paymentMethodCtx, {
      type: 'bar',
      data: {
        labels: paymentMethodData.map(m => m.name),
        datasets: [{
          label: 'Revenue',
          data: paymentMethodData.map(m => m.revenue),
          backgroundColor: '#3b82f6'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '$' + value.toLocaleString();
              }
            }
          }
        }
      }
    });

    // Daily Revenue Chart
    const dailyCtx = document.getElementById('dailyRevenueChart').getContext('2d');
    const dailyData = {
      {
        daily_revenue | safe
      }
    };

    new Chart(dailyCtx, {
      type: 'line',
      data: {
        labels: dailyData.map(d => d.date),
        datasets: [{
          label: 'Daily Revenue',
          data: dailyData.map(d => d.revenue),
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.2,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day',
              displayFormats: {
                day: 'MMM d'
              }
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '$' + value.toLocaleString();
              }
            }
          }
        }
      }
    });

    // Export to CSV function
    function exportToCSV() {
      const params = new URLSearchParams({
        start_date: '{{ start_date|date:"Y-m-d" }}',
        end_date: '{{ end_date|date:"Y-m-d" }}',
        format: 'csv'
      });
      window.location.href = `{% url 'finance:revenue-analysis-export' %}?${params}`;
    }
  </script>
{% endblock %}
