{% extends "scheduling/base_scheduling.html" %}

{% load i18n static %}

{% block
  page_title %}
  {{ class.course.code }} - {{ class.course.title }}
{% endblock %}
{%
block page_subtitle %}
<div class="mt-1 flex flex-col sm:flex-row sm:flex-wrap sm:mt-0 sm:space-x-6">
  <div class="mt-2 flex items-center text-sm text-gray-500">
    <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400"
         fill="currentColor"
         viewBox="0 0 20 20">
      <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z" />
    </svg>
    {% trans "Section" %} {{ class.section_id }}
  </div>
  <div class="mt-2 flex items-center text-sm text-gray-500">
    <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400"
         fill="currentColor"
         viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
    </svg>
    {{ class.term.name }}
  </div>
  <div class="mt-2 flex items-center text-sm text-gray-500">
    <svg class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400"
         fill="currentColor"
         viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
    </svg>
    {{ class.get_time_of_day_display }}
  </div>
</div>
{% endblock %}
{% block header_actions %}
  <div class="flex items-center space-x-3">
    <!-- Status Badge -->
    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium {% if class.status == 'ACTIVE' %}bg-green-100 text-green-800 {% elif class.status == 'DRAFT' %}bg-gray-100 text-gray-800 {% elif class.status == 'SCHEDULED' %}bg-blue-100 text-blue-800 {% elif class.status == 'COMPLETED' %}bg-purple-100 text-purple-800 {% elif class.status == 'CANCELLED' %}bg-red-100 text-red-800 {% else %}bg-yellow-100 text-yellow-800{% endif %}">
      {{ class.get_status_display }}
    </span>
    <!-- Actions -->
    {% if perms.scheduling.can_edit_class %}
      <a href="{% url 'scheduling:class_edit' class.pk %}"
         class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        <svg class="h-4 w-4 mr-1.5"
             fill="none"
             stroke="currentColor"
             viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
        </svg>
        {% trans "Edit" %}
      </a>
    {% endif %}
    <!-- More Actions Dropdown -->
    <div class="relative inline-block text-left">
      <button type="button"
              class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              onclick="toggleDropdown('more-actions')">
        {% trans "More" %}
        <svg class="ml-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
      <div id="more-actions"
           class="hidden origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
        <div class="py-1">
          <a href="#"
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
            <svg class="inline h-4 w-4 mr-2"
                 fill="none"
                 stroke="currentColor"
                 viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            {% trans "Copy Class" %}
          </a>
          <a href="#"
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
            <svg class="inline h-4 w-4 mr-2"
                 fill="none"
                 stroke="currentColor"
                 viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
            </svg>
            {% trans "Export Data" %}
          </a>
          <a href="#"
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
            <svg class="inline h-4 w-4 mr-2"
                 fill="none"
                 stroke="currentColor"
                 viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            {% trans "Print Roster" %}
          </a>
          {% if class.status != 'CANCELLED' %}
            <hr class="my-1" />
            <a href="#"
               hx-post="{% url 'scheduling:class_cancel' class.pk %}"
               hx-confirm="{% trans 'Are you sure you want to cancel this class?' %}"
               class="block px-4 py-2 text-sm text-red-700 hover:bg-red-50">
              <svg class="inline h-4 w-4 mr-2"
                   fill="none"
                   stroke="currentColor"
                   viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              {% trans "Cancel Class" %}
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block scheduling_content %}
  <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
    <!-- Main Content - 2 columns -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Class Information -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden transition-all duration-200 hover:shadow-md">
        <div class="px-4 py-3 border-b bg-gray-50 border-gray-200 flex items-center justify-between">
          <h3 class="text-lg font-medium text-gray-900">
            <span class="inline-flex items-center">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="ml-2">{% trans "Class Information" %}</span>
            </span>
          </h3>
        </div>
        <div class="p-4">
          <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
            <div>
              <dt class="text-sm font-medium text-gray-500">{% trans "Course Code" %}</dt>
              <dd class="mt-1 text-sm text-gray-900">
                {{ class.course.code }}
              </dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">{% trans "Course Title" %}</dt>
              <dd class="mt-1 text-sm text-gray-900">
                {{ class.course.title }}
              </dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">{% trans "Credits" %}</dt>
              <dd class="mt-1 text-sm text-gray-900">
                {{ class.course.credits }}
              </dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">{% trans "Class Type" %}</dt>
              <dd class="mt-1 text-sm text-gray-900">
                {{ class.get_class_type_display }}
              </dd>
            </div>
            {% if class.is_combined %}
              <div class="sm:col-span-2">
                <dt class="text-sm font-medium text-gray-500">{% trans "Combined With" %}</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  {{ class.combined_course_codes }}
                </dd>
              </div>
            {% endif %}
            {% if class.notes %}
              <div class="sm:col-span-2">
                <dt class="text-sm font-medium text-gray-500">{% trans "Notes" %}</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  {{ class.notes }}
                </dd>
              </div>
            {% endif %}
          </dl>
        </div>
      </div>
      <!-- Sessions and Parts -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden transition-all duration-200 hover:shadow-md">
        <div class="px-4 py-3 border-b bg-gray-50 border-gray-200 flex items-center justify-between">
          <h3 class="text-lg font-medium text-gray-900">
            <span class="inline-flex items-center">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="ml-2">{% trans "Schedule Details" %}</span>
            </span>
          </h3>
        </div>
        <div class="p-4">
          <div class="space-y-4">
            {% for session in class.class_sessions.all %}
              <div class="border-l-4 border-blue-400 pl-4">
                <h4 class="text-sm font-medium text-gray-900">
                  {% if session.session_name %}
                    {{ session.session_name }}
                  {% else
                    %}
                    {% if session.is_ieap_session %}
                      Session {{
                      session.session_number }}
                    {% endif %}
                  {% endif %}
                </h4>
                <div class="mt-2 space-y-2">
                  {% for part in session.class_parts.all %}
                    <div class="bg-gray-50 rounded-md p-3">
                      <div class="flex items-start justify-between">
                        <div>
                          <p class="text-sm font-medium text-gray-900">
                            {{ part.get_class_part_type_display }}
                            {% if part.name %}
                              -
                              {{ part.name }}
                            {% endif %}
                          </p>
                          <p class="mt-1 text-sm text-gray-600">
                            {{ part.meeting_days }}
                            {% if part.start_time %}
                              • {{
                              part.start_time|time:"g:i A" }} - {{
                              part.end_time|time:"g:i A" }}
                            {% endif %}
                          </p>
                          {% if part.room %}
                            <p class="mt-1 text-sm text-gray-600">
                              <svg class="inline h-4 w-4 mr-1"
                                   fill="none"
                                   stroke="currentColor"
                                   viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                              </svg>
                              {{ part.room.building.short_name }} {{
                              part.room.room_number }}
                            </p>
                          {% endif %}
                          {% if part.teacher %}
                            <p class="mt-1 text-sm text-gray-600">
                              <svg class="inline h-4 w-4 mr-1"
                                   fill="none"
                                   stroke="currentColor"
                                   viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                              </svg>
                              {{ part.teacher.person.get_full_name }}
                            </p>
                          {% endif %}
                        </div>
                        <div class="text-right">
                          <span class="text-xs text-gray-500">{% trans "Weight" %}</span>
                          <p class="text-sm font-medium text-gray-900">{{ part.grade_weight|floatformat:1 }}</p>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    <!-- Sidebar - 1 column -->
    <div class="space-y-6">
      <!-- Enrollment Summary -->
      <div class="bg-white shadow-sm rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">{% trans "Enrollment Summary" %}</h3>
        <!-- Capacity Bar -->
        <div class="mb-4">
          <div class="flex justify-between text-sm text-gray-600 mb-1">
            <span>{{ class.enrollment_count }} {% trans "enrolled" %}</span>
            <span>{{ class.max_enrollment }} {% trans "max" %}</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div class="h-2 rounded-full transition-all duration-300 {% if class.is_full %}bg-red-600 {% elif class.enrollment_count > class.max_enrollment|floatformat:0|mul:0.8 %}bg-yellow-500 {% else %}bg-green-600{% endif %}"
                 style="width: {{ class.enrollment_count|floatformat:0|mul:100|div:class.max_enrollment }}%"></div>
          </div>
        </div>
        <dl class="space-y-2">
          <div class="flex justify-between">
            <dt class="text-sm text-gray-500">{% trans "Available Spots" %}</dt>
            <dd class="text-sm font-medium text-gray-900">
              {{ class.available_spots }}
            </dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-sm text-gray-500">{% trans "Waitlist" %}</dt>
            <dd class="text-sm font-medium text-gray-900">
              {{ waitlist_count|default:"0" }}
            </dd>
          </div>
        </dl>
        {% if perms.scheduling.can_manage_enrollments %}
          <div class="mt-4">
            <a href="{% url 'scheduling:class_enrollments' class.pk %}"
               class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
              {% trans "Manage Enrollments" %}
            </a>
          </div>
        {% endif %}
      </div>
      <!-- Quick Stats -->
      <div class="bg-white shadow-sm rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">{% trans "Quick Stats" %}</h3>
        <dl class="space-y-3">
          <div>
            <dt class="text-sm text-gray-500">{% trans "Attendance Rate" %}</dt>
            <dd class="mt-1">
              <div class="flex items-baseline">
                <span class="text-2xl font-semibold text-gray-900">{{ attendance_rate|default:"--" }}%</span>
              </div>
            </dd>
          </div>
          <div>
            <dt class="text-sm text-gray-500">{% trans "Average Grade" %}</dt>
            <dd class="mt-1">
              <div class="flex items-baseline">
                <span class="text-2xl font-semibold text-gray-900">{{ avg_grade|default:"--" }}</span>
              </div>
            </dd>
          </div>
        </dl>
      </div>
      <!-- Actions -->
      <div class="bg-white shadow-sm rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-4">{% trans "Actions" %}</h3>
        <div class="space-y-2">
          <button type="button"
                  onclick="window.print()"
                  class="w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <svg class="h-4 w-4 mr-2"
                 fill="none"
                 stroke="currentColor"
                 viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            {% trans "Print Details" %}
          </button>
          <a href="{% url 'scheduling:class_roster' class.pk %}"
             class="w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            <svg class="h-4 w-4 mr-2"
                 fill="none"
                 stroke="currentColor"
                 viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            {% trans "View Roster" %}
          </a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block scheduling_js %}
  <script>
    function toggleDropdown(dropdownId) {
      const dropdown = document.getElementById(dropdownId);
      dropdown.classList.toggle('hidden');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
      const dropdowns = document.querySelectorAll('[id$="-actions"]');
      dropdowns.forEach((dropdown) => {
        if (!dropdown.contains(event.target) && !event.target.closest('button')) {
          dropdown.classList.add('hidden');
        }
      });
    });
  </script>
{% endblock %}
