{% extends "admin/change_list.html" %}

{% load i18n admin_urls static admin_list %}

{% block result_list %}
  <!-- Summary Statistics -->
  {% if activity_stats %}
    <div class="module" style="margin-bottom: 20px;">
      <h2>{% trans "Activity Summary" %} ({{ date_range }})</h2>
      <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div style="flex: 1;
                    padding: 15px;
                    background-color: #f8f9fa;
                    border-radius: 5px">
          <h3 style="margin-top: 0; color: #333;">{% trans "Total Logs" %}</h3>
          <p style="font-size: 24px; font-weight: bold; margin: 0; color: #007bff">
            {{ activity_stats.total_logs|default:"0" }}
          </p>
        </div>
        <div style="flex: 1;
                    padding: 15px;
                    background-color: #f8f9fa;
                    border-radius: 5px">
          <h3 style="margin-top: 0; color: #333;">{% trans "Last 30 Days" %}</h3>
          <p style="font-size: 24px; font-weight: bold; margin: 0; color: #28a745">
            {{ activity_stats.recent_logs|default:"0" }}
          </p>
        </div>
      </div>
      <div style="display: flex; gap: 20px;">
        <!-- Top Activity Types -->
        <div style="flex: 1;">
          <h3>{% trans "Top Activity Types" %}</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background-color: #f8f9fa;">
                <th style="padding: 8px;
                           text-align: left;
                           border-bottom: 1px solid #dee2e6">{% trans "Activity Type" %}</th>
                <th style="padding: 8px;
                           text-align: right;
                           border-bottom: 1px solid #dee2e6">{% trans "Count" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for activity in activity_stats.activity_breakdown %}
                <tr>
                  <td style="padding: 8px; border-bottom: 1px solid #dee2e6;">{{ activity.activity_type }}</td>
                  <td style="padding: 8px;
                             text-align: right;
                             border-bottom: 1px solid #dee2e6">{{ activity.count }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="2" style="padding: 8px; text-align: center; color: #6c757d;">{% trans "No activity data" %}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <!-- Visibility Breakdown -->
        <div style="flex: 1;">
          <h3>{% trans "Visibility Breakdown" %}</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background-color: #f8f9fa;">
                <th style="padding: 8px;
                           text-align: left;
                           border-bottom: 1px solid #dee2e6">{% trans "Visibility" %}</th>
                <th style="padding: 8px;
                           text-align: right;
                           border-bottom: 1px solid #dee2e6">{% trans "Count" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for vis in activity_stats.visibility_breakdown %}
                <tr>
                  <td style="padding: 8px; border-bottom: 1px solid #dee2e6;">
                    {% if vis.visibility == "STAFF_ONLY" %}
                      <span style="color: #dc3545;">{% trans "Staff Only" %}</span>
                    {% elif vis.visibility == "STUDENT_VISIBLE" %}
                      <span style="color: #28a745;">{% trans "Student Visible" %}</span>
                    {% elif vis.visibility == "PUBLIC" %}
                      <span style="color: #007bff;">{% trans "Public" %}</span>
                    {% else %}
                      {{ vis.visibility }}
                    {% endif %}
                  </td>
                  <td style="padding: 8px;
                             text-align: right;
                             border-bottom: 1px solid #dee2e6">{{ vis.count }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="2" style="padding: 8px; text-align: center; color: #6c757d;">{% trans "No visibility data" %}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <!-- Top Students -->
        <div style="flex: 1;">
          <h3>{% trans "Most Active Students" %}</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background-color: #f8f9fa;">
                <th style="padding: 8px;
                           text-align: left;
                           border-bottom: 1px solid #dee2e6">{% trans "Student" %}</th>
                <th style="padding: 8px;
                           text-align: right;
                           border-bottom: 1px solid #dee2e6">{% trans "Activities" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for student in activity_stats.top_students %}
                <tr>
                  <td style="padding: 8px; border-bottom: 1px solid #dee2e6;">
                    <strong>{{ student.student_number }}</strong>
                    <br />
                    <small style="color: #6c757d;">{{ student.student_name|truncatechars:25 }}</small>
                  </td>
                  <td style="padding: 8px;
                             text-align: right;
                             border-bottom: 1px solid #dee2e6">{{ student.count }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="2" style="padding: 8px; text-align: center; color: #6c757d;">{% trans "No student data" %}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Quick Filters -->
    <div class="module" style="margin-bottom: 20px;">
      <h2>{% trans "Quick Filters" %}</h2>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <a href="?activity_type=CLASS_ENROLLMENT"
           class="button"
           style="background-color: #28a745;
                  color: white">{% trans "Enrollments" %}</a>
        <a href="?activity_type=CLASS_WITHDRAWAL"
           class="button"
           style="background-color: #dc3545;
                  color: white">{% trans "Withdrawals" %}</a>
        <a href="?activity_type=GRADE_CHANGE"
           class="button"
           style="background-color: #ffc107;
                  color: black">{% trans "Grade Changes" %}</a>
        <a href="?activity_type=MANAGEMENT_OVERRIDE"
           class="button"
           style="background-color: #e83e8c;
                  color: white">{% trans "Overrides" %}</a>
        <a href="?visibility=STAFF_ONLY"
           class="button"
           style="background-color: #6c757d;
                  color: white">{% trans "Staff Only" %}</a>
        <a href="?visibility=STUDENT_VISIBLE"
           class="button"
           style="background-color: #17a2b8;
                  color: white">{% trans "Student Visible" %}</a>
        <a href="?created_at__gte={{ date_range|slice:":10" }}" class="button">{% trans "Last 30 Days" %}</a>
        <a href="?" class="button default">{% trans "Clear Filters" %}</a>
      </div>
    </div>
  {% endif %}
  <!-- Standard result list -->
  {{ block.super }}
{% endblock %}
{% block extrahead %}
  {{ block.super }}
  <style>
    /* Custom styles for activity log admin */
    .button {
      padding: 5px 15px;
      border-radius: 3px;
      text-decoration: none;
      border: 1px solid transparent;
      display: inline-block;
      font-size: 13px;
      line-height: 1.5;
      transition: all 0.15s;
    }

    .button:hover {
      opacity: 0.8;
      transform: translateY(-1px);
    }

    .button.default {
      background-color: #f8f9fa;
      color: #333;
      border-color: #dee2e6;
    }

    .results table td {
      vertical-align: middle;
    }

    /* Responsive adjustments */
    @media (max-width: 767px) {
      .module>div[style*="display: flex"] {
        flex-direction: column;
      }
    }
  </style>
{% endblock %}
