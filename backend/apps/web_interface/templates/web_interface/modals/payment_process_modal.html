{% extends "web_interface/modals/base_modal.html" %}

{% load i18n %}
{% load web_interface_tags %}

{% block modal_content %}
  <form id="payment-process-form"
        hx-post="{% url 'web_interface:payment-processing' %}"
        hx-target="#modal-overlay"
        hx-swap="outerHTML"
        hx-indicator="#payment-process-loading">
    {% csrf_token %}
    <div class="form-sections">
      {% if selected_invoice %}
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="fas fa-file-invoice"></i>
            {% trans "Invoice Information" %}
          </h4>
          <div class="invoice-summary">
            <div class="invoice-details">
              <div class="detail-row">
                <span class="detail-label">{% trans "Invoice:" %}</span>
                <span class="detail-value">{{ selected_invoice.invoice_number }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">{% trans "Student:" %}</span>
                <span class="detail-value">{{ selected_invoice.student.person.full_name }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">{% trans "Total Amount:" %}</span>
                <span class="detail-value amount">{{ selected_invoice.total_amount|format_currency }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">{% trans "Amount Due:" %}</span>
                <span class="detail-value amount-due">{{ selected_invoice.amount_due|format_currency }}</span>
              </div>
            </div>
          </div>
          <input type="hidden" name="invoice_id" value="{{ selected_invoice.id }}" />
        </div>
      {% else %}
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="fas fa-search"></i>
            {% trans "Select Invoice" %}
          </h4>
          <div class="form-group">
            <label for="invoice-search" class="form-label required">{% trans "Invoice" %}</label>
            <div class="invoice-search-container">
              <input type="text"
                     id="invoice-search"
                     class="form-input"
                     placeholder="{% trans 'Search by invoice number or student name...' %}"
                     hx-get="{% url 'web_interface:invoice-search' %}"
                     hx-target="#invoice-search-results"
                     hx-trigger="keyup changed delay:500ms"
                     autocomplete="off" />
              <div id="invoice-search-results" class="search-results"></div>
            </div>
            <input type="hidden" id="invoice_id" name="invoice_id" required />
          </div>
        </div>
      {% endif %}
      <div class="form-section">
        <h4 class="form-section-title">
          <i class="fas fa-credit-card"></i>
          {% trans "Payment Details" %}
        </h4>
        <div class="form-row">
          <div class="form-group">
            <label for="amount" class="form-label required">{% trans "Payment Amount" %}</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number"
                     id="amount"
                     name="amount"
                     class="form-input"
                     step="0.01"
                     min="0.01"
                     {% if selected_invoice %}max="{{ selected_invoice.amount_due }}"{% endif %}
                     required />
            </div>
            {% if selected_invoice %}
              <div class="form-help">
                {% trans "Maximum:" %} {{ selected_invoice.amount_due|format_currency }}
                <a href="#" onclick="setMaxAmount()" class="text-link">{% trans "(Use full amount)" %}</a>
              </div>
            {% endif %}
          </div>
          <div class="form-group">
            <label for="payment_method" class="form-label required">{% trans "Payment Method" %}</label>
            <select id="payment_method"
                    name="payment_method"
                    class="form-select"
                    required>
              <option value="">{% trans "Select method..." %}</option>
              <option value="CASH">{% trans "Cash" %}</option>
              <option value="CREDIT_CARD">{% trans "Credit Card" %}</option>
              <option value="BANK_TRANSFER">{% trans "Bank Transfer" %}</option>
              <option value="CHECK">{% trans "Check" %}</option>
              <option value="ONLINE">{% trans "Online Payment" %}</option>
              <option value="SCHOLARSHIP">{% trans "Scholarship" %}</option>
              <option value="OTHER">{% trans "Other" %}</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="payer_name" class="form-label">{% trans "Payer Name" %}</label>
          <input type="text"
                 id="payer_name"
                 name="payer_name"
                 class="form-input"
                 placeholder="{% trans 'Name of person making payment (if different from student)' %}" />
        </div>
        <div class="form-group">
          <label for="external_reference" class="form-label">{% trans "Reference Number" %}</label>
          <input type="text"
                 id="external_reference"
                 name="external_reference"
                 class="form-input"
                 placeholder="{% trans 'Transaction ID, check number, etc.' %}" />
        </div>
        <div class="form-group">
          <label for="notes" class="form-label">{% trans "Payment Notes" %}</label>
          <textarea id="notes"
                    name="notes"
                    class="form-textarea"
                    rows="3"
                    placeholder="{% trans 'Additional notes about this payment...' %}"></textarea>
        </div>
      </div>
      <div class="form-section">
        <h4 class="form-section-title">
          <i class="fas fa-receipt"></i>
          {% trans "Receipt Options" %}
        </h4>
        <div class="form-check">
          <input type="checkbox"
                 id="print_receipt"
                 name="print_receipt"
                 class="form-checkbox"
                 checked />
          <label for="print_receipt" class="form-check-label">{% trans "Print receipt after processing" %}</label>
        </div>
        <div class="form-check">
          <input type="checkbox"
                 id="send_confirmation"
                 name="send_confirmation"
                 class="form-checkbox" />
          <label for="send_confirmation" class="form-check-label">{% trans "Send email confirmation to student" %}</label>
        </div>
      </div>
    </div>
    <div id="payment-process-loading" class="htmx-indicator">
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        {% trans "Processing payment..." %}
      </div>
    </div>
  </form>
  <script>
    // Set maximum payment amount
    function setMaxAmount() {
      {
        %
        if selected_invoice %
      }
      document.getElementById('amount').value = '{{ selected_invoice.amount_due }}';
      {
        %
        endif %
      }
    }

    // Handle invoice selection from search results
    document.addEventListener('click', function(e) {
      if (e.target.closest('.invoice-search-result')) {
        const result = e.target.closest('.invoice-search-result');
        const invoiceId = result.dataset.invoiceId;
        const invoiceNumber = result.dataset.invoiceNumber;
        const amountDue = result.dataset.amountDue;

        document.getElementById('invoice_id').value = invoiceId;
        document.getElementById('invoice-search').value = invoiceNumber;
        document.getElementById('invoice-search-results').innerHTML = '';

        // Update max amount
        const amountInput = document.getElementById('amount');
        amountInput.max = amountDue;
        amountInput.placeholder = `Max: $${amountDue}`;
      }
    });

    // Auto-fill payer name with student name if available
    document.addEventListener('change', function(e) {
      if (e.target.id === 'payment_method' && e.target.value !== '') {
        const payerNameInput = document.getElementById('payer_name');
        if (!payerNameInput.value && '{{ selected_invoice.student.person.full_name|default:"" }}') {
          payerNameInput.value = '{{ selected_invoice.student.person.full_name|default:"" }}';
        }
      }
    });
  </script>
{% endblock %}
{% block modal_footer %}
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" onclick="closeModal()">{% trans "Cancel" %}</button>
    <button type="submit" class="btn btn-success" form="payment-process-form">
      <i class="fas fa-credit-card"></i>
      {% trans "Process Payment" %}
    </button>
  </div>
{% endblock %}
