<!-- Student Locator Results Partial (loaded via HTMX) -->
{% load i18n %}

{% if students %}
<div class="results-card">
    <div class="results-header">
        <h3>
            {% trans "Found" %} <span id="resultCountUpdate">{{ students|length }}</span> {% trans "students" %}
        </h3>
        <div class="export-buttons">
            <button onclick="exportResults('csv')" class="export-btn">
                {% trans "Export CSV" %}
            </button>
            <button onclick="exportResults('excel')" class="export-btn">
                {% trans "Export Excel" %}
            </button>
        </div>
    </div>
    
    <div style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th>{% trans "Student ID" %}</th>
                    <th>{% trans "Name" %}</th>
                    <th>{% trans "Khmer Name" %}</th>
                    <th>{% trans "Email" %}</th>
                    <th>{% trans "Program" %}</th>
                    <th>{% trans "Status" %}</th>
                    <th>{% trans "Balance" %}</th>
                    <th>{% trans "Enrolled" %}</th>
                    <th>{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td><strong>{{ student.student_id }}</strong></td>
                    <td>{{ student.person.full_name }}</td>
                    <td class="khmer-name-cell">
                        {% if student.person.khmer_name %}
                            <div class="khmer-name">
                                {{ student.person.khmer_name }}
                                {% if student.person.khmer_name_source == 'approximated' %}
                                    <span class="approximated-badge" title="{% trans 'System Approximated' %}">*</span>
                                {% endif %}
                            </div>
                            {% if student.person.khmer_name_confidence %}
                                <small class="confidence-score">{{ student.person.khmer_name_confidence|floatformat:2 }}</small>
                            {% endif %}
                        {% else %}
                            <span style="color: #9ca3af;">â€”</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if student.person.school_email %}
                            {{ student.person.school_email }}
                        {% elif student.person.personal_email %}
                            {{ student.person.personal_email }}
                        {% else %}
                            <span style="color: #ef4444;">{% trans "No email" %}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if student.current_program %}
                            {{ student.current_program }}
                        {% else %}
                            <span style="color: #718096;">{% trans "TBD" %}</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-{{ student.current_status|lower }}">
                            {{ student.get_current_status_display }}
                        </span>
                    </td>
                    <td>
                        {% if student.current_balance %}
                            ${{ student.current_balance|floatformat:2 }}
                        {% else %}
                            $0.00
                        {% endif %}
                    </td>
                    <td>
                        {% if student.last_enrollment_date %}
                            {{ student.last_enrollment_date|date:"M d, Y" }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <a href="{% url 'web_interface:student-detail' student.pk %}" 
                               class="action-btn btn-view">
                                {% trans "View" %}
                            </a>
                            <a href="{% url 'web_interface:student-update' student.pk %}" 
                               class="action-btn btn-edit">
                                {% trans "Edit" %}
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if is_paginated %}
    <div style="padding: 1rem; border-top: 1px solid #e2e8f0;">
        <div class="pagination">
            {% if page_obj.has_previous %}
            <a href="#" 
               hx-get="{% url 'web_interface:student-locator-results' %}?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}"
               hx-target="#search-results">
                {% trans "Previous" %}
            </a>
            {% endif %}
            
            <span class="active">
                {% trans "Page" %} {{ page_obj.number }} {% trans "of" %} {{ page_obj.paginator.num_pages }}
            </span>
            
            {% if page_obj.has_next %}
            <a href="#" 
               hx-get="{% url 'web_interface:student-locator-results' %}?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}"
               hx-target="#search-results">
                {% trans "Next" %}
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Update the result count in the stats card
    document.getElementById('resultCount').textContent = '{{ page_obj.paginator.count|default:students|length }}';
    
    function exportResults(format) {
        const form = document.getElementById('student-search-form');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        params.append('export', format);
        window.location.href = "{% url 'web_interface:student-locator-export' %}?" + params.toString();
    }
</script>

{% else %}
<div class="results-card">
    <div class="no-results">
        <h3>{% trans "No students found" %}</h3>
        <p>{% trans "Try adjusting your search criteria" %}</p>
    </div>
</div>

<script>
    document.getElementById('resultCount').textContent = '0';
</script>
{% endif %}

<style>
.khmer-name-cell {
    min-width: 150px;
}

.khmer-name {
    font-family: 'Khmer OS', serif;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.approximated-badge {
    color: #007bff;
    font-weight: bold;
    font-size: 1.1rem;
    cursor: help;
}

.confidence-score {
    color: #6c757d;
    font-size: 0.75rem;
    display: block;
    margin-top: 0.125rem;
}
</style>