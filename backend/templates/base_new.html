{% load static i18n %}

<!DOCTYPE html>
{% get_current_language as LANGUAGE_CODE %}
<html lang="{{ LANGUAGE_CODE }}" class="h-full">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>
      {% block title %}
        {{ system_name|default:"Naga SIS" }}
      {% endblock title %}
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="{% static 'favicon.ico' %}" />
    {% block css %}
      <!-- Tailwind CSS -->
      <script src="https://cdn.tailwindcss.com"></script>
      <!-- Font Awesome -->
      <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
      <!-- Google Fonts -->
      <link rel="preconnect" href="https://fonts.googleapis.com" />
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet" />
      <style>
        body {
          font-family: 'Inter', sans-serif;
        }

        /* Smooth transitions for sidebar and content */
        #sidebar,
        #main-content {
          transition: all 0.3s ease-in-out;
        }

        /* Styles for when sidebar is collapsed */
        .sidebar-collapsed #sidebar {
          width: 4.5rem;
          /* 72px */
        }

        .sidebar-collapsed .sidebar-label,
        .sidebar-collapsed .sidebar-header-text {
          display: none;
        }

        .sidebar-collapsed .sidebar-item {
          justify-content: center;
        }

        .sidebar-collapsed #main-content {
          margin-left: 4.5rem;
        }

        @media (max-width: 1024px) {
          .sidebar-collapsed #main-content {
            margin-left: 0;
          }

          .sidebar-collapsed #sidebar {
            transform: translateX(-100%);
          }
        }
      </style>
      {% block extra_css %}
      {% endblock extra_css %}
    {% endblock css %}
  </head>
  <body class="antialiased bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200">
    <div class="relative min-h-screen lg:flex">
      <!-- Sidebar -->
      <aside id="sidebar"
             class="bg-slate-800 w-64 lg:w-72 flex-shrink-0 fixed lg:relative inset-y-0 left-0 z-30 shadow-lg lg:shadow-none overflow-y-auto">
        <div class="py-4">
          <!-- Current Term Section -->
          <div class="current-term-section px-4 pb-4 border-b border-slate-700">
            <div class="text-gray-400 text-xs font-medium uppercase tracking-wide">{% trans "Current Term" %}</div>
            <div class="text-slate-50 text-sm font-medium mt-1">{{ current_term|default:"No Active Term" }}</div>
          </div>
          <!-- Main Navigation -->
          <nav class="pt-4"
               role="navigation"
               aria-label="{% trans 'Main navigation' %}">
            <!-- Dashboard -->
            <a href="/"
               class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
               {% if request.resolver_match.url_name == 'home' %}aria-current="page"{% endif %}>
              <i class="fas fa-home w-5 text-center mr-3" aria-hidden="true"></i>
              <span>{% trans "Dashboard" %}</span>
            </a>
            <!-- Students Section -->
            <div class="nav-section mt-2">
              <div class="nav-section-header px-4 py-2 mx-2">
                <div class="text-gray-400 text-xs font-medium uppercase tracking-wide">{% trans "Students" %}</div>
              </div>
              <a href="{% url 'people:student-profile-list' %}"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
                 {% if request.resolver_match.url_name == 'student-profile-list' %}aria-current="page"{% endif %}>
                <i class="fas fa-users w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "All Students" %}</span>
              </a>
              <a href="{% url 'people:student-profile-create' %}"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
                 {% if request.resolver_match.url_name == 'student-profile-create' %}aria-current="page"{% endif %}>
                <i class="fas fa-user-plus w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Add Student" %}</span>
              </a>
              <a href="{% url 'people:student-profile-list' %}"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
                 {% if request.resolver_match.url_name in 'student-profile-list,student-profile-detail' %}aria-current="page"{% endif %}>
                <i class="fas fa-id-card w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Student Records" %}</span>
              </a>
            </div>
            <!-- Level Testing Section -->
            <div class="nav-section mt-4">
              <div class="nav-section-header px-4 py-2 mx-2">
                <div class="text-gray-400 text-xs font-medium uppercase tracking-wide">{% trans "Level Testing" %}</div>
              </div>
              <a href="{% url 'level_testing:application_start' %}"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
                 {% if request.resolver_match.url_name == 'application_start' %}aria-current="page"{% endif %}>
                <i class="fas fa-file-signature w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Student Application" %}</span>
              </a>
              {% if request.user.is_staff %}
                <a href="{% url 'level_testing:staff_dashboard' %}"
                   class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
                   {% if request.resolver_match.url_name == 'staff_dashboard' %}aria-current="page"{% endif %}>
                  <i class="fas fa-tachometer-alt w-5 text-center mr-3" aria-hidden="true"></i>
                  <span>{% trans "Staff Dashboard" %}</span>
                </a>
                <a href="{% url 'level_testing:staff_applications' %}"
                   class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
                   {% if request.resolver_match.url_name == 'staff_applications' %}aria-current="page"{% endif %}>
                  <i class="fas fa-list-alt w-5 text-center mr-3" aria-hidden="true"></i>
                  <span>{% trans "Application Management" %}</span>
                </a>
              {% endif %}
            </div>
            <!-- Academic Section -->
            <div class="nav-section mt-4">
              <div class="nav-section-header px-4 py-2 mx-2">
                <div class="text-gray-400 text-xs font-medium uppercase tracking-wide">{% trans "Academic" %}</div>
              </div>
              <a href="#"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                <i class="fas fa-book w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Courses" %}</span>
              </a>
              <a href="{% url 'scheduling:dashboard' %}"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
                 {% if 'scheduling' in request.resolver_match.url_name %}aria-current="page"{% endif %}>
                <i class="fas fa-calendar-alt w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Class Schedule" %}</span>
              </a>
              <a href="#"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                <i class="fas fa-graduation-cap w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Enrollment" %}</span>
              </a>
              <a href="#"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                <i class="fas fa-star w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Grades" %}</span>
              </a>
              <a href="#"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                <i class="fas fa-check-circle w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Attendance" %}</span>
              </a>
            </div>
            <!-- Finance Section -->
            <div class="nav-section mt-4">
              <div class="nav-section-header px-4 py-2 mx-2">
                <div class="text-gray-400 text-xs font-medium uppercase tracking-wide">{% trans "Finance" %}</div>
              </div>
              <a href="{% url 'finance:dashboard' %}"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
                 {% if 'finance' in request.resolver_match.url_name and 'dashboard' in request.resolver_match.url_name %}aria-current="page"{% endif %}>
                <i class="fas fa-chart-line w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Finance Dashboard" %}</span>
              </a>
              <a href="{% url 'finance:cashier-dashboard' %}"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
                 {% if 'cashier' in request.resolver_match.url_name %}aria-current="page"{% endif %}>
                <i class="fas fa-cash-register w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Cashier" %}</span>
              </a>
              <a href="{% url 'finance:outstanding-balances' %}"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
                 {% if 'outstanding-balances' in request.resolver_match.url_name %}aria-current="page"{% endif %}>
                <i class="fas fa-dollar-sign w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Outstanding Balances" %}</span>
              </a>
              <a href="{% url 'finance:fee-management' %}"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
                 {% if 'fee-management' in request.resolver_match.url_name %}aria-current="page"{% endif %}>
                <i class="fas fa-file-invoice-dollar w-5 text-center mr-3"
                   aria-hidden="true"></i>
                <span>{% trans "Fee Management" %}</span>
              </a>
              <a href="{% url 'finance:scholarship-overview' %}"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
                 {% if 'scholarship' in request.resolver_match.url_name %}aria-current="page"{% endif %}>
                <i class="fas fa-hand-holding-usd w-5 text-center mr-3"
                   aria-hidden="true"></i>
                <span>{% trans "Scholarships" %}</span>
              </a>
              <a href="{% url 'finance:reports-hub' %}"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
                 {% if 'finance' in request.resolver_match.url_name and 'reports' in request.resolver_match.url_name %}aria-current="page"{% endif %}>
                <i class="fas fa-chart-bar w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Financial Reports" %}</span>
              </a>
            </div>
            <!-- Reports Section -->
            <div class="nav-section mt-4">
              <div class="nav-section-header px-4 py-2 mx-2">
                <div class="text-gray-400 text-xs font-medium uppercase tracking-wide">{% trans "Reports" %}</div>
              </div>
              <a href="#"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                <i class="fas fa-chart-bar w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Academic Reports" %}</span>
              </a>
              <a href="#"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                <i class="fas fa-chart-line w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Financial Reports" %}</span>
              </a>
              <a href="#"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                <i class="fas fa-file-export w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Export Data" %}</span>
              </a>
            </div>
            <!-- Administration Section -->
            {% if request.user.is_staff %}
              <div class="nav-section mt-4">
                <div class="nav-section-header px-4 py-2 mx-2">
                  <div class="text-gray-400 text-xs font-medium uppercase tracking-wide">{% trans "Administration" %}</div>
                </div>
                <a href="{% url 'admin:index' %}"
                   class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                  <i class="fas fa-cog w-5 text-center mr-3" aria-hidden="true"></i>
                  <span>{% trans "Admin Panel" %}</span>
                </a>
                <a href="#"
                   class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                  <i class="fas fa-users-cog w-5 text-center mr-3" aria-hidden="true"></i>
                  <span>{% trans "User Management" %}</span>
                </a>
                <a href="#"
                   class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                  <i class="fas fa-database w-5 text-center mr-3" aria-hidden="true"></i>
                  <span>{% trans "System Settings" %}</span>
                </a>
              </div>
            {% endif %}
            <!-- Test Templates Section -->
            <div class="nav-section mt-4">
              <div class="nav-section-header px-4 py-2 mx-2">
                <div class="text-gray-400 text-xs font-medium uppercase tracking-wide">{% trans "Test Templates" %}</div>
              </div>
              <a href="{% url 'legacy-test-new-base' %}"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring"
                 {% if request.resolver_match.url_name == 'legacy-test-new-base' %}aria-current="page"{% endif %}>
                <i class="fas fa-desktop w-5 text-center mr-3" aria-hidden="true"></i>
                <span>Base New Template</span>
              </a>
              <a href="{% url 'people:test-adaptive' %}"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                <i class="fas fa-flask w-5 text-center mr-3" aria-hidden="true"></i>
                <span>Base Adaptive</span>
              </a>
              <a href="{% url 'people:test-student-simple' %}"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                <i class="fas fa-vial w-5 text-center mr-3" aria-hidden="true"></i>
                <span>Base Adaptive Simple</span>
              </a>
            </div>
            <!-- Settings Section -->
            <div class="nav-section mt-4 mb-4">
              <div class="nav-section-header px-4 py-2 mx-2">
                <div class="text-gray-400 text-xs font-medium uppercase tracking-wide">{% trans "Settings" %}</div>
              </div>
              <a href="#"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                <i class="fas fa-user w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Profile" %}</span>
              </a>
              <a href="#"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                <i class="fas fa-sliders-h w-5 text-center mr-3" aria-hidden="true"></i>
                <span>{% trans "Preferences" %}</span>
              </a>
              <a href="#"
                 class="nav-link flex items-center px-4 py-3 mx-2 text-gray-200 no-underline rounded-lg transition-all duration-200 hover:bg-slate-700 hover:text-white focus-ring">
                <i class="fas fa-question-circle w-5 text-center mr-3"
                   aria-hidden="true"></i>
                <span>{% trans "Help" %}</span>
              </a>
            </div>
          </nav>
        </div>
      </aside>
      <!-- Main Content Area -->
      <div id="main-content" class="flex-1 flex flex-col lg:ml-72">
        <!-- Header -->
        <header class="bg-white dark:bg-slate-800 h-16 flex-shrink-0 border-b border-slate-200 dark:border-slate-700">
          <div class="h-full px-4 lg:px-6 flex items-center justify-between">
            <!-- Left side: Hamburger Menu -->
            <div class="flex items-center">
              <button id="sidebar-toggle"
                      class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">
                <i class="fas fa-bars"></i>
              </button>
            </div>
            <!-- Right side: Actions & User Menu -->
            <div class="flex items-center space-x-4">
              <!-- Messages -->
              <button class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 relative">
                <i class="fas fa-bell"></i>
                <span class="absolute top-1 right-1 h-2 w-2 bg-red-500 rounded-full"></span>
              </button>
              <!-- Language Toggle -->
              <button class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
                <i class="fas fa-language"></i>
              </button>
              <!-- Light/Dark Toggle -->
              <button id="theme-toggle"
                      class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
                <!-- Icon will be set by JS -->
              </button>
              <!-- User Menu -->
              <div class="flex items-center space-x-3">
                <div class="h-9 w-9 rounded-full bg-slate-300 dark:bg-slate-600 flex items-center justify-center">
                  <i class="fas fa-user text-slate-600 dark:text-slate-300"></i>
                </div>
                <span class="text-sm font-medium hidden sm:block">{{ user.username|default:"Staff Member" }}</span>
              </div>
            </div>
          </div>
        </header>
        <!-- Page Content -->
        <main class="flex-grow p-4 sm:p-6 lg:p-8">
          {% block content %}
          {% endblock content %}
        </main>
      </div>
    </div>
    {% block extra_js %}
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const sidebarToggle = document.getElementById('sidebar-toggle');
          const themeToggle = document.getElementById('theme-toggle');
          const htmlElement = document.documentElement;
          const bodyElement = document.body;

          const sunIcon = `<i class="fas fa-sun text-yellow-400"></i>`;
          const moonIcon = `<i class="fas fa-moon text-slate-500"></i>`;

          // --- State Initialization ---

          // 1. Theme (Dark/Light Mode)
          const savedTheme = localStorage.getItem('theme') || 'light';
          htmlElement.classList.toggle('dark', savedTheme === 'dark');
          themeToggle.innerHTML = savedTheme === 'dark' ? sunIcon : moonIcon;

          // 2. Sidebar State
          // Collapsed on mobile by default, respects localStorage on desktop
          const isMobile = window.innerWidth < 1024;
          let isSidebarCollapsed = isMobile ? true : localStorage.getItem('sidebarCollapsed') === 'true';
          bodyElement.classList.toggle('sidebar-collapsed', isSidebarCollapsed);

          // --- Event Listeners ---

          // Sidebar Toggle
          if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => {
              const isCollapsed = bodyElement.classList.toggle('sidebar-collapsed');
              // Only save preference on desktop to avoid overriding mobile-first default
              if (!isMobile) {
                localStorage.setItem('sidebarCollapsed', isCollapsed);
              }
            });
          }

          // Theme Toggle
          if (themeToggle) {
            themeToggle.addEventListener('click', () => {
              const isDark = htmlElement.classList.toggle('dark');
              localStorage.setItem('theme', isDark ? 'dark' : 'light');
              themeToggle.innerHTML = isDark ? sunIcon : moonIcon;
            });
          }
        });
      </script>
    {% endblock extra_js %}
  </body>
</html>
