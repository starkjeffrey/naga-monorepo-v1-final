# Rate Limiting Configuration for Staff-Web V2 Production

# Define rate limiting zones
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=static:10m rate=50r/s;
limit_req_zone $binary_remote_addr zone=general:10m rate=20r/s;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn_zone $server_name zone=perserver:10m;

# Rate limiting rules for different endpoints
map $request_uri $rate_limit_zone {
    default                 "general";
    ~^/api/auth/login      "login";
    ~^/api/auth/register   "login";
    ~^/api/auth/password   "login";
    ~^/api/                "api";
    ~\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ "static";
}

# Apply rate limiting in server blocks
# limit_req zone=$rate_limit_zone burst=20 nodelay;
# limit_conn perip 10;
# limit_conn perserver 100;

# Deny access to sensitive paths
location ~ ^/(\.env|\.git|\.svn|\.htaccess|\.htpasswd) {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# Block common attack patterns
location ~* (wp-admin|wp-content|wp-includes|xmlrpc\.php|phpmyadmin|adminer) {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# Block suspicious user agents
map $http_user_agent $blocked_agent {
    default         0;
    ~*bot           0;  # Allow legitimate bots
    ~*crawler       0;  # Allow legitimate crawlers
    ~*spider        0;  # Allow legitimate spiders
    ~*scanner       1;  # Block scanners
    ~*nikto         1;  # Block nikto
    ~*sqlmap        1;  # Block sqlmap
    ~*nmap          1;  # Block nmap
    ~*masscan       1;  # Block masscan
    ~*zmap          1;  # Block zmap
    ""              1;  # Block empty user agents
}

# Apply blocking
if ($blocked_agent) {
    return 403;
}

# Limit request size
client_max_body_size 50m;
client_body_buffer_size 128k;
client_header_buffer_size 3m;
large_client_header_buffers 4 256k;

# Timeout protection
client_body_timeout 60s;
client_header_timeout 60s;
keepalive_timeout 10 10;
send_timeout 60s;

# Slow HTTP attack protection
reset_timedout_connection on;

# Geographic blocking (example - uncomment and configure as needed)
# geoip_country /usr/share/GeoIP/GeoIP.dat;
# map $geoip_country_code $allowed_country {
#     default no;
#     US yes;
#     CA yes;
#     GB yes;
#     AU yes;
# }
#
# if ($allowed_country = no) {
#     return 403;
# }